/**
 * üé® SmartLink Page - Design √©pur√© avec carte centrale
 * Design moderne, style Apple Music/Spotify avec carte blanche centr√©e
 */

import React, { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import { Helmet, HelmetProvider } from "react-helmet-async";
import apiService from "../../services/api.service";
import { useTerritorialFilter } from "../../hooks/useGeolocation";
import { usePlatformOrder, usePlatformOrderAnalytics } from "../../hooks/usePlatformOrder";
import { useURLGeneration, useClickTracking, useUTMParams, useSocialMetadata } from "../../hooks/useURLGeneration";
import "./SmartLinkPageClean.css";

// üéØ Fonction d'injection des analytics c√¥t√© client
const injectAnalyticsScripts = async (trackingIds) => {
  if (!trackingIds) {
    console.warn("üéØ Pas de trackingIds fournis");
    return;
  }
  
  console.log("üéØ Injection analytics c√¥t√© client:", trackingIds);
  
  // üéØ Google Analytics 4
  if (trackingIds.ga4Id && trackingIds.ga4Id.trim()) {
    if (!window.gtag) {
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${trackingIds.ga4Id}`;
      document.head.appendChild(script);
      
      await new Promise(resolve => {
        script.onload = () => {
          window.dataLayer = window.dataLayer || [];
          function gtag(){window.dataLayer.push(arguments);}
          window.gtag = gtag;
          gtag('js', new Date());
          gtag('config', trackingIds.ga4Id, {
            page_title: document.title,
            page_location: window.location.href,
            custom_parameter: 'smartlink_client_injection'
          });
          console.log("üéØ GA4 inject√© c√¥t√© client:", trackingIds.ga4Id);
          resolve();
        };
      });
    }
  }
  
  // üéØ Google Tag Manager
  if (trackingIds.gtmId && trackingIds.gtmId.trim()) {
    if (!window.dataLayer) {
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtm.js?id=${trackingIds.gtmId}`;
      document.head.appendChild(script);
      
      console.log("üéØ GTM inject√© c√¥t√© client:", trackingIds.gtmId);
    }
  }
  
  // üéØ Meta Pixel
  if (trackingIds.metaPixelId && trackingIds.metaPixelId.trim()) {
    if (!window.fbq) {
      !function(f,b,e,v,n,t,s) {
        if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)
      }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
      
      window.fbq('init', trackingIds.metaPixelId);
      window.fbq('track', 'PageView');
      console.log("üéØ Meta Pixel inject√© c√¥t√© client:", trackingIds.metaPixelId);
    }
  }
  
  // üéØ TikTok Pixel
  if (trackingIds.tiktokPixelId && trackingIds.tiktokPixelId.trim()) {
    if (!window.ttq) {
      !function (w, d, t) {
        w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=i,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=i+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
        ttq.load(trackingIds.tiktokPixelId);
        ttq.page();
        console.log("üéØ TikTok Pixel inject√© c√¥t√© client:", trackingIds.tiktokPixelId);
      }(window, document, 'ttq');
    }
  }
};

// Import des ic√¥nes des plateformes
import {
  SiSpotify,
  SiApplemusic,
  SiYoutubemusic,
  SiAmazonmusic,
  SiTidal,
  SiSoundcloud,
  SiYoutube,
  SiPandora
} from 'react-icons/si';
import { MdMusicNote, MdLibraryMusic, MdQueueMusic } from 'react-icons/md';

const SmartLinkPageClean = () => {
  console.log("üé® SmartLinkPageClean - Design √©pur√© charg√©!");
  
  const { artistSlug, trackSlug } = useParams();
  const [smartLinkData, setSmartLinkData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // üé® Solution A : React State pour background image
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [backgroundLoaded, setBackgroundLoaded] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = React.useRef(null);

  // üåç Filtrage territorial des plateformes
  const platformLinks = smartLinkData?.smartLink?.platformLinks || [];
  const {
    filtered: territorialPlatforms,
    isLoading: geoLoading,
    location,
    total,
    kept
  } = useTerritorialFilter(platformLinks, {
    autoDetect: true,
    enableCache: true
  });

  // üéõÔ∏è Ordre personnalis√© avec A/B testing
  const {
    platforms: availablePlatforms,
    orderSource,
    abTestVariant
  } = usePlatformOrder(territorialPlatforms, {
    enableABTest: true,
    userCountry: location?.countryCode,
    autoApply: true
  });

  // üìä Analytics pour l'ordre des plateformes
  const { trackPlatformClick } = usePlatformOrderAnalytics();

  // üîó G√©n√©ration d'URLs propres et tracking
  const { urls, socialMetadata, trackClick } = useURLGeneration(smartLinkData, {
    format: 'artist',
    enableMultiChannel: true
  });

  // üìä Tracking avanc√© des clics
  const { trackClick: trackSmartLinkClick } = useClickTracking(smartLinkData);

  // üè∑Ô∏è Param√®tres UTM dans l'URL actuelle
  const { utmParams, hasUTM, source: utmSource } = useUTMParams();

  // üåê M√©tadonn√©es sociales
  const { updateMetaTags } = useSocialMetadata(smartLinkData);

  // üé® Gestion de la classe body pour retirer la couleur de fond
  useEffect(() => {
    document.body.classList.add('smartlink-page');
    return () => {
      document.body.classList.remove('smartlink-page');
    };
  }, []);

  useEffect(() => {
    console.log("üéØ SmartLinkPageClean mounted with params:", { artistSlug, trackSlug });
    
    const fetchSmartLink = async () => {
      try {
        setLoading(true);
        setError(null);
        console.log("üîó Chargement SmartLink:", { artistSlug, trackSlug });
        
        const response = await apiService.smartlinks.getBySlugs(artistSlug, trackSlug);
        
        if (response && response.success && response.data) {
          console.log("‚úÖ SmartLink charg√©:", response.data);
          
          // üé® DEBUG - Logs obligatoires pour diagnostic
          console.log("üé® DEBUG - SmartLink data:", response.data);
          console.log("üé® DEBUG - Cover URL:", response.data.smartLink?.coverImageUrl);
          console.log("üé® DEBUG - Cover URL type:", typeof response.data.smartLink?.coverImageUrl);
          
          setSmartLinkData(response.data);
          
          // üéØ INJECTION C√îT√â CLIENT des analytics pour HashRouter
          await injectAnalyticsScripts(response.data.smartLink?.trackingIds);
          
          // üåê Mettre √† jour les m√©tadonn√©es sociales
          setTimeout(() => {
            updateMetaTags();
          }, 100);
          
          // üé® BACKGROUND ARTWORK selon vos sp√©cifications exactes
          const artworkUrl = response.data.smartLink?.coverImageUrl;
          console.log("üé® Artwork URL found:", artworkUrl);
          
          // üß™ Test 1 : URL Validity
          const validateImageUrl = (url) => {
            if (!url) return false;
            if (typeof url !== 'string') return false;
            if (!url.startsWith('http')) return false;
            return true;
          };
          
          // üé® Solution A : React State (RECOMMAND√âE)
          if (validateImageUrl(artworkUrl)) {
            console.log("üé® DEBUG - Attempting to load:", artworkUrl);
            console.log("üé® DEBUG - URL validation passed");
            
            const img = new Image();
            img.onload = () => {
              console.log("‚úÖ DEBUG - Image loaded successfully");
              setBackgroundImage(artworkUrl);
              setBackgroundLoaded(true);
              console.log("üé® DEBUG - React state updated with background image");
            };
            
            img.onerror = (error) => {
              console.error("‚ùå DEBUG - Image load failed:", artworkUrl, error);
              console.error("Image load failed, using fallback");
              setBackgroundLoaded(true); // Affiche le fallback
            };
            
            img.src = artworkUrl;
          } else {
            console.warn("‚ùå DEBUG - Invalid image URL:", artworkUrl);
            console.warn("üé® No artwork URL found in SmartLink data");
            setBackgroundLoaded(true); // Affiche le fallback
          }
        } else {
          throw new Error(response?.error || "SmartLink non trouv√©");
        }
      } catch (err) {
        console.error("‚ùå Erreur SmartLink:", err);
        setError(err.message || "Erreur de chargement");
      } finally {
        setLoading(false);
      }
    };

    if (artistSlug && trackSlug) {
      fetchSmartLink();
    } else {
      setError("Param√®tres manquants");
      setLoading(false);
    }

    // üé® Cleanup automatique avec React State (plus besoin de manipulation DOM)
  }, [artistSlug, trackSlug]);

  // üéµ Gestion de la lecture audio
  // üìä Fonction pour tracker les clics dans la base de donn√©es
  const trackPlatformClickToDatabase = async (smartLinkId, platformName) => {
    try {
      console.log(`üìä Envoi tracking clic: ${platformName} pour SmartLink ${smartLinkId}`);
      
      // Validation des param√®tres
      if (!smartLinkId || !platformName) {
        console.warn('‚ö†Ô∏è Param√®tres manquants pour le tracking:', { smartLinkId, platformName });
        return;
      }

      const response = await fetch(`https://mdmcv4-backend-production-b615.up.railway.app/api/v1/smartlinks/${smartLinkId}/log-platform-click`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          platformName: platformName
        })
      });

      if (response.ok) {
        const result = await response.json();
        console.log(`‚úÖ Clic ${platformName} enregistr√©:`, result.data);
        console.log(`üìä Total clics: ${result.data.totalClicks}, Clics ${platformName}: ${result.data.platformClicks}`);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
        console.warn(`‚ö†Ô∏è √âchec tracking ${platformName} (${response.status}):`, errorData.error);
        
        // Log d√©taill√© pour debug
        if (response.status === 404) {
          console.warn(`üîç SmartLink ID ${smartLinkId} introuvable - v√©rifiez que le SmartLink existe`);
        } else if (response.status === 401) {
          console.warn('üîê Erreur d\'authentification - v√©rifiez la configuration API');
        }
      }
    } catch (error) {
      console.error(`‚ùå Erreur r√©seau tracking ${platformName}:`, error);
      // Ne pas interrompre l'exp√©rience utilisateur pour une erreur de tracking
    }
  };

  const handlePlayAudio = async (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    console.log('üéµ Play button clicked!');
    console.log('üéµ Audio ref:', audioRef.current);
    console.log('üéµ Audio URL:', smartLinkData?.smartLink?.previewAudioUrl);
    console.log('üéµ Is playing:', isPlaying);
    
    const audioUrl = smartLinkData?.smartLink?.previewAudioUrl;
    
    if (!audioUrl) {
      console.log('‚ùå Pas d\'URL audio disponible');
      return;
    }

    // Initialiser l'audio element si pas encore fait
    if (!audioRef.current) {
      console.log('üéµ Initialisation audio element');
      audioRef.current = new Audio(audioUrl);
      audioRef.current.onended = () => setIsPlaying(false);
      audioRef.current.onpause = () => setIsPlaying(false);
      audioRef.current.onplay = () => setIsPlaying(true);
    }

    try {
      if (isPlaying) {
        console.log('‚è∏Ô∏è Pausing audio');
        audioRef.current.pause();
        setIsPlaying(false);
      } else {
        console.log('‚ñ∂Ô∏è Playing audio from:', audioUrl);
        
        // S'assurer que la source est correcte
        if (audioRef.current.src !== audioUrl) {
          audioRef.current.src = audioUrl;
        }
        
        await audioRef.current.play();
        setIsPlaying(true);
        console.log('‚úÖ Audio started playing');
      }
    } catch (error) {
      console.error('‚ùå Erreur lecture audio:', error);
      setIsPlaying(false);
      
      // Essayer de cr√©er un nouvel √©l√©ment audio
      try {
        audioRef.current = new Audio(audioUrl);
        await audioRef.current.play();
        setIsPlaying(true);
        console.log('‚úÖ Audio started playing (retry)');
      } catch (retryError) {
        console.error('‚ùå Erreur m√™me en retry:', retryError);
      }
    }
  };

  const handlePlatformClick = (platform, url) => {
    console.log(`üîó Clicked on ${platform.platform}:`, url);
    
    // üìä Tracking de l'ordre des plateformes
    const platformPosition = availablePlatforms.findIndex(p => p.platform === platform.platform) + 1;
    trackPlatformClick(platform.platform, platformPosition);
    
    // üéØ Tracking analytics inject√©s c√¥t√© client
    if (window.gtag) {
      window.gtag('event', 'platform_click', {
        event_category: 'smartlink',
        event_label: platform.platform,
        smartlink_artist: artistSlug,
        smartlink_track: trackSlug,
        platform_position: platformPosition,
        custom_parameter: 'smartlink_client_tracking'
      });
      console.log("üéØ GA4 tracking: platform_click", platform.platform);
    }
    
    if (window.dataLayer) {
      window.dataLayer.push({
        event: 'smartlink_platform_click',
        platform: platform.platform,
        artist: artistSlug,
        track: trackSlug,
        position: platformPosition,
        order_source: orderSource,
        ab_test_variant: abTestVariant
      });
      console.log("üéØ GTM tracking: smartlink_platform_click", platform.platform);
    }
    
    if (window.fbq) {
      window.fbq('track', 'Lead', {
        content_name: `${artistSlug} - ${trackSlug}`,
        content_category: 'Music',
        platform: platform.platform,
        value: platformPosition
      });
      console.log("üéØ Meta Pixel tracking: Lead", platform.platform);
    }
    
    if (window.ttq) {
      window.ttq.track('ClickButton', {
        content_name: `${artistSlug} - ${trackSlug}`,
        platform: platform.platform,
        button_text: platform.platform
      });
      console.log("üéØ TikTok Pixel tracking: ClickButton", platform.platform);
    }
    
    // üîó Tracking avanc√© avec URLs et UTM
    const currentUrl = window.location.href;
    trackSmartLinkClick(currentUrl, platform.platform, {
      position: platformPosition,
      orderSource,
      abTestVariant,
      utmSource,
      hasUTM,
      destinationUrl: url
    });
    
    // üìä Tracking avec service URLs
    trackClick(url, {
      platform: platform.platform,
      position: platformPosition,
      source: utmSource || 'direct'
    });
    
    // üìä Enregistrer le clic dans la base de donn√©es
    if (smartLinkData?.smartLink?._id) {
      console.log("üìä Tracking platform click:", { 
        platform: platform.platform, 
        position: platformPosition,
        orderSource,
        abTestVariant,
        utmParams 
      });
      
      // Appel API pour tracker le clic
      trackPlatformClickToDatabase(smartLinkData.smartLink._id, platform.platform);
    }
    
    // Redirect to platform
    setTimeout(() => {
      window.open(url, '_blank');
    }, 150);
  };

  const getPlatformIcon = (platformName) => {
    const platform = platformName.toLowerCase().replace(/\s+/g, '');
    
    const iconMap = {
      'spotify': SiSpotify,
      'applemusic': SiApplemusic,
      'apple': SiApplemusic,
      'youtubemusic': SiYoutubemusic,
      'youtube': SiYoutube,
      'amazonmusic': SiAmazonmusic,
      'amazon': SiAmazonmusic,
      'deezer': MdMusicNote,
      'tidal': SiTidal,
      'soundcloud': SiSoundcloud,
      'pandora': SiPandora,
      'itunes': SiApplemusic,
      'napster': MdLibraryMusic,
      'audiomack': MdQueueMusic,
      'anghami': MdMusicNote,
      'qobuz': MdMusicNote
    };

    return iconMap[platform] || MdMusicNote;
  };

  const getPlatformCTA = (platformName) => {
    const platform = platformName.toLowerCase();
    if (platform.includes('itunes') || platform.includes('amazon')) return 'Download';
    return 'Play';
  };

  const getPlatformSubtext = (platformName) => {
    const subtexts = {
      'Spotify': 'Music for everyone',
      'Apple Music': 'Music everywhere',
      'YouTube Music': 'Music videos & more',
      'Amazon Music': 'Prime music',
      'Deezer': 'High quality music',
      'Tidal': 'High fidelity',
      'SoundCloud': 'Music & audio',
      'YouTube': 'Watch & listen',
      'Pandora': 'Radio & podcasts',
      'iTunes': 'Download music',
      'Napster': 'Music streaming',
      'Audiomack': 'Hip-hop & more'
    };
    return subtexts[platformName] || 'Music streaming';
  };

  if (loading) {
    return (
      <div className="smartlink-clean">
        <div className="background-artwork"></div>
        <div className="main-card">
          <div className="loading-container">
            <div className="loading-spinner"></div>
            <p>Loading...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="smartlink-clean">
        <div className="background-artwork"></div>
        <div className="main-card">
          <div className="error-container">
            <h2>üòï Not Found</h2>
            <p>{error}</p>
          </div>
        </div>
      </div>
    );
  }

  if (!smartLinkData?.smartLink || !smartLinkData?.artist) {
    return (
      <div className="smartlink-clean">
        <div className="background-artwork"></div>
        <div className="main-card">
          <div className="error-container">
            <h2>üòï Missing Data</h2>
            <p>Unable to load SmartLink data</p>
          </div>
        </div>
      </div>
    );
  }

  const { smartLink, artist } = smartLinkData;
  const title = `${smartLink.trackTitle} - ${artist.name}`;
  const coverImage = smartLink.coverImageUrl || "https://via.placeholder.com/120x120/f0f0f0/666?text=üéµ";

  return (
    <HelmetProvider>
      <Helmet>
        <title>{title}</title>
        <meta name="description" content={`Listen to ${smartLink.trackTitle} by ${artist.name} on your favorite platform.`} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={`Listen to ${smartLink.trackTitle} by ${artist.name} on your favorite platform.`} />
        <meta property="og:image" content={coverImage} />
        <meta property="og:type" content="music.song" />
      </Helmet>
      
      <div className="smartlink-clean">
        {/* üé® Background artwork avec React State (Solution A) */}
        <div 
          className={`background-artwork ${backgroundLoaded ? 'loaded' : ''}`}
          style={{
            backgroundImage: backgroundImage ? `url("${backgroundImage}")` : 'none'
          }}
        ></div>
        
        {/* üé® Carte centrale selon vos sp√©cifications */}
        <div className="main-card">
          {/* Pochette de l'album avec bouton play int√©gr√© */}
          <div 
            className={`album-cover-container ${!smartLinkData?.smartLink?.previewAudioUrl ? 'disabled' : ''}`}
            onClick={(e) => {
              e.stopPropagation();
              console.log('üñ±Ô∏è Container clicked!', e);
              console.log('üéµ Preview audio URL:', smartLinkData?.smartLink?.previewAudioUrl);
              if (smartLinkData?.smartLink?.previewAudioUrl) {
                handlePlayAudio();
              }
            }}
          >
            <img 
              src={coverImage}
              alt={`${smartLink.trackTitle} - ${artist.name}`} 
              className="album-cover"
            />
            {/* Afficher le bouton play seulement si on a une URL audio */}
            {smartLinkData?.smartLink?.previewAudioUrl && (
              <div 
                className="play-overlay-btn"
                onClick={(e) => {
                  e.stopPropagation();
                  console.log('üñ±Ô∏è Play button clicked directly!');
                  handlePlayAudio(e);
                }}
              >
                <div className={`play-triangle ${isPlaying ? 'playing' : ''}`}></div>
              </div>
            )}
          </div>
          
          {/* Titre de l'album centr√© */}
          <h1 className="album-title">{smartLink.trackTitle}</h1>
          
          {/* Nom de l'artiste */}
          <p className="artist-name">{artist.name}</p>
          
          {/* Sous-titre */}
          <div className="subtitle">
            {smartLink.useDescriptionAsSubtitle && smartLink.description 
              ? smartLink.description 
              : smartLink.customSubtitle || "Choose music service"
            }
          </div>
          
          {/* Liste verticale des plateformes */}
          <div className="platform-list">
            {availablePlatforms?.filter(link => link.url && link.platform).map((platform, index) => {
              const IconComponent = getPlatformIcon(platform.platform);
              return (
                <div 
                  key={`${platform.platform}-${index}`}
                  className="platform-row" 
                  onClick={() => handlePlatformClick(platform, platform.url)}
                >
                  {/* Logo + Nom √† gauche */}
                  <div className="platform-left">
                    <IconComponent className="platform-logo" />
                    <div className="platform-info">
                      <span className="platform-name">{platform.platform}</span>
                      <span className="platform-subtext">{getPlatformSubtext(platform.platform)}</span>
                    </div>
                  </div>
                  
                  {/* Bouton √† droite */}
                  <button className="platform-btn">
                    {getPlatformCTA(platform.platform)}
                  </button>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </HelmetProvider>
  );
};

export default SmartLinkPageClean;